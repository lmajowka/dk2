<%= form_with model: level do |f| %>
  <% if level.errors.any? %>
    <div class="error-list">
      <ul>
        <% level.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="form-group">
    <%= f.label :name, "Nome do Level" %>
    <%= f.text_field :name, placeholder: "Digite o nome do level..." %>
  </div>

  <div
    class="map-editor-container"
    data-controller="map-editor"
    data-map-editor-initial-map-value='<%= level.map.to_json %>'
    data-map-editor-tile-urls-value="<%= tile_urls_json %>"
    data-map-editor-prop-assets-value="<%= prop_urls_json %>"
    data-map-editor-initial-props-value='<%= level.props.to_json %>'>

    <div class="map-editor-header">
      <h3 class="map-editor-title">üó∫Ô∏è Map Editor</h3>
      <div class="map-editor-controls">
        <label>
          Colunas
          <input
            type="number"
            min="1"
            step="1"
            value="<%= (level.map[0]&.length || 24) %>"
            data-map-editor-target="colsInput"
            data-action="change->map-editor#setCols">
        </label>
        <button type="button" class="map-editor-btn map-editor-btn-secondary" data-action="click->map-editor#addCols" data-map-editor-delta-param="10">+10</button>
        <button type="button" class="map-editor-btn map-editor-btn-secondary" data-action="click->map-editor#addCols" data-map-editor-delta-param="-10">-10</button>
      </div>
    </div>

    <div class="palette-container" data-map-editor-target="palette">
      <span class="palette-label">Pincel:</span>
      <div class="palette-items">
        <button
          type="button"
          class="palette-item empty-tile"
          data-tile="0"
          data-action="click->map-editor#selectTile"
          data-map-editor-tile-param="0"
          title="Apagar">
          <span class="palette-item-label">Vazio</span>
        </button>
        <% tile_assets.each_with_index do |tile, index| %>
          <button
            type="button"
            class="palette-item<%= index == 0 ? ' selected' : '' %>"
            data-tile="<%= tile[:id] %>"
            data-action="click->map-editor#selectTile"
            data-map-editor-tile-param="<%= tile[:id] %>"
            style="background-image: url('<%= asset_path(tile[:path]) %>')"
            title="<%= tile[:name] %>">
            <span class="palette-item-label"><%= tile[:name] %></span>
          </button>
        <% end %>
      </div>
    </div>

    <%= f.hidden_field :map, value: level.map.to_json, data: { map_editor_target: "input" } %>

    <div class="grid-container">
      <div data-map-editor-target="grid"></div>
    </div>

    <!-- Props Section -->
    <div class="props-section">
      <div class="props-header">
        <h3 class="props-title">üèõÔ∏è Background Props</h3>
      </div>

      <% if prop_assets.any? %>
        <div class="props-palette-container" data-map-editor-target="propsPalette">
          <span class="palette-label">Selecionar Prop:</span>
          <div class="palette-items">
            <% prop_assets.each_with_index do |prop, index| %>
              <button
                type="button"
                class="palette-item<%= index == 0 ? ' selected' : '' %>"
                data-prop="<%= prop[:id] %>"
                data-action="click->map-editor#selectProp"
                data-map-editor-prop-param="<%= prop[:id] %>"
                style="background-image: url('<%= asset_path(prop[:path]) %>')"
                title="<%= prop[:name] %>">
                <span class="palette-item-label"><%= prop[:name] %></span>
              </button>
            <% end %>
          </div>
          <button type="button" class="map-editor-btn map-editor-btn-add" data-action="click->map-editor#addProp">
            + Adicionar Prop
          </button>
        </div>

        <div class="props-preview-container" data-map-editor-target="propsPreview">
          <p class="props-empty">Nenhuma prop adicionada. Clique em "Adicionar Prop" para come√ßar.</p>
        </div>
      <% else %>
        <p class="props-empty">Nenhuma prop dispon√≠vel. Adicione imagens na pasta <code>background_props</code>.</p>
      <% end %>

      <%= f.hidden_field :props, value: level.props.to_json, data: { map_editor_target: "propsInput" } %>
    </div>
  </div>

  <div class="form-actions">
    <%= f.submit "Salvar Level", class: "submit-btn" %>
  </div>
<% end %>
